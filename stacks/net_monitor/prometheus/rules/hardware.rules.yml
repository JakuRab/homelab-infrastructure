# Hardware Health Alerting Rules
# These rules alert on critical hardware issues: high temps, disk failures, etc.

groups:
  - name: hardware_health
    interval: 60s
    rules:
      # === Temperature Alerts ===

      - alert: CPUTemperatureHigh
        expr: node_hwmon_temp_celsius{chip=~".*coretemp.*"} > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU temperature on {{ $labels.instance }}"
          description: "CPU temperature is {{ $value }}°C on {{ $labels.instance }} (threshold: 80°C)"

      - alert: CPUTemperatureCritical
        expr: node_hwmon_temp_celsius{chip=~".*coretemp.*"} > 90
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "CRITICAL CPU temperature on {{ $labels.instance }}"
          description: "CPU temperature is {{ $value }}°C on {{ $labels.instance }} - immediate action required!"

      - alert: DiskTemperatureHigh
        expr: smartctl_device_temperature > 60
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High disk temperature on {{ $labels.instance }}"
          description: "Disk {{ $labels.device }} ({{ $labels.model_name }}) is {{ $value }}°C (threshold: 60°C)"

      # === Disk Health Alerts ===

      - alert: DiskSMARTFailed
        expr: smartctl_device_smart_status == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "SMART health check FAILED on {{ $labels.device }}"
          description: "Disk {{ $labels.device }} ({{ $labels.model_name }}) on {{ $labels.instance }} has failed SMART status - replace immediately!"

      - alert: DiskReallocatedSectorsIncreasing
        expr: increase(smartctl_device_reallocated_sector_count[24h]) > 0
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Reallocated sectors increasing on {{ $labels.device }}"
          description: "Disk {{ $labels.device }} on {{ $labels.instance }} has reallocated {{ $value }} sectors in last 24h - drive may be failing"

      - alert: DiskPendingSectors
        expr: smartctl_device_current_pending_sector_count > 0
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Pending sectors detected on {{ $labels.device }}"
          description: "Disk {{ $labels.device }} on {{ $labels.instance }} has {{ $value }} pending sectors - check drive health"

      - alert: SSDWearLevelHigh
        expr: smartctl_device_percentage_used > 80
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "SSD wear level high on {{ $labels.device }}"
          description: "SSD {{ $labels.device }} on {{ $labels.instance }} has consumed {{ $value }}% of lifespan - plan replacement"

      - alert: SSDWearLevelCritical
        expr: smartctl_device_percentage_used > 90
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "SSD wear level CRITICAL on {{ $labels.device }}"
          description: "SSD {{ $labels.device }} on {{ $labels.instance }} has consumed {{ $value }}% of lifespan - replace soon!"

      # === Filesystem Alerts ===

      - alert: FilesystemNearlyFull
        expr: (node_filesystem_avail_bytes{mountpoint!~"/boot.*"} / node_filesystem_size_bytes) < 0.10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Filesystem nearly full on {{ $labels.instance }}"
          description: "Filesystem {{ $labels.mountpoint }} on {{ $labels.instance }} has less than 10% space remaining"

      - alert: FilesystemCriticallyFull
        expr: (node_filesystem_avail_bytes{mountpoint!~"/boot.*"} / node_filesystem_size_bytes) < 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Filesystem CRITICALLY full on {{ $labels.instance }}"
          description: "Filesystem {{ $labels.mountpoint }} on {{ $labels.instance }} has less than 5% space remaining - immediate action required!"

      # === System Resource Alerts ===

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      - alert: HighCPUUsage
        expr: (1 - avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m]))) > 0.90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # === IPMI Alerts (if deployed) ===

      - alert: IPMIFanSpeedLow
        expr: ipmi_fan_speed_rpm < 500 and ipmi_fan_speed_rpm > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Fan speed low on {{ $labels.instance }}"
          description: "Fan {{ $labels.name }} on {{ $labels.instance }} is {{ $value }} RPM - check cooling"

      - alert: IPMIVoltageCritical
        expr: ipmi_voltage_state != 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Voltage critical on {{ $labels.instance }}"
          description: "Voltage sensor {{ $labels.name }} on {{ $labels.instance }} is in critical state - check PSU"

      # === Exporter Down Alerts ===

      - alert: NodeExporterDown
        expr: up{job="node-exporter"} == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Node Exporter down on {{ $labels.instance }}"
          description: "Cannot scrape hardware metrics from {{ $labels.instance }}"

      - alert: SmartctlExporterDown
        expr: up{job="smartctl"} == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Smartctl Exporter down on {{ $labels.instance }}"
          description: "Cannot scrape disk health metrics from {{ $labels.instance }}"
